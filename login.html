<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h1>Login to Inventory System</h1>
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <p id="error-message" style="color: red"></p>

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0-beta.0/dist/umd/supabase.min.js"></script>

    <!-- Your custom JavaScript -->
    <script>
      // Initialize Supabase client
      const supabaseUrl = "https://twjuvshslihzobyamtfj.supabase.co"; // Replace with your actual Supabase URL
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3anV2c2hzbGloem9ieWFtdGZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1MTQxOTMsImV4cCI6MjA1MTA5MDE5M30.3mE-W4CskWOg4490dgm-bjMmdo8cghAk6y7JCDtco1g"; // Replace with your actual Supabase anon key
      const supabase = createClient(supabaseUrl, supabaseKey);

      // Handle login form submission
      document
        .getElementById("login-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          console.log("Login form submitted"); // Log message to confirm form submission

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          try {
            // Attempt to sign in the user
            const { user, error } = await supabase.auth.signInWithPassword({
              email,
              password,
            });

            if (error) {
              // Show error message
              console.error("Login error:", error.message); // Log error to console
              document.getElementById("error-message").innerText =
                error.message;
              return;
            }

            // If login successful, redirect based on role
            await redirectToRolePage();
          } catch (err) {
            console.error("Unexpected error:", err); // Log unexpected errors
            document.getElementById("error-message").innerText =
              "Something went wrong!";
          }
        });

      // Redirect user based on role
      async function redirectToRolePage() {
        const user = supabase.auth.user(); // Get the authenticated user

        if (!user) {
          alert("No user logged in!");
          return;
        }

        try {
          const { data, error } = await supabase
            .from("users")
            .select("role")
            .eq("email", user.email)
            .single();

          if (error) {
            console.error("Error fetching role:", error);
            alert("Unable to determine role.");
            return;
          }

          const role = data.role;
          if (role === "admin") {
            window.location.href = "admin.html"; // Redirect to the admin page
          } else if (role === "viewer") {
            window.location.href = "index.html"; // Redirect to the viewer page
          } else {
            alert("Invalid role detected.");
          }
        } catch (error) {
          console.error("Error fetching user role:", error);
          alert("Error while determining role.");
        }
      }
    </script>
  </body>
</html>
